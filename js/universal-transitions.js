/**
 * –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞–Ω–∏–º–∞—Ü–∏–π –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –º–µ–∂–¥—É —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏
 * –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É –≤—Å–µ–º–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏ —Å–∞–π—Ç–∞ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π –∑–∞—Ç–µ–º–Ω–µ–Ω–∏—è
 */

class UniversalPageTransitions {
    static isTransitioning = false;
    static transitionDuration = 1200;
    static overlay = null;
    
    static init() {
        try {
            console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UniversalPageTransitions...');
            this.createTransitionOverlay();
            this.setupPageTransitions();
            this.handlePageEntrance();
            console.log('‚úÖ UniversalPageTransitions —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ UniversalPageTransitions:', error);
        }
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ–≤–µ—Ä–ª–µ–π –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
     */
    static createTransitionOverlay() {
        if (this.overlay) return;
        
        this.overlay = document.createElement('div');
        this.overlay.className = 'page-transition-overlay';
        this.overlay.id = 'universalTransitionOverlay';
        document.body.appendChild(this.overlay);
        
        console.log('üì± –û–≤–µ—Ä–ª–µ–π –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ —Å–æ–∑–¥–∞–Ω');
    }

    /**
     * –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤—Å–µ—Ö —Å—Å—ã–ª–æ–∫ –Ω–∞ —Å–∞–π—Ç–µ
     */
    static setupPageTransitions() {
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤—Å–µ—Ö —Å—Å—ã–ª–æ–∫, –≤–µ–¥—É—â–∏—Ö –Ω–∞ –¥—Ä—É–≥–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        this.setupMainNavigation();
        this.setupContentNavigation();
        this.setupCalendarNavigation();
        this.setupAuthNavigation();
        
        console.log('üîó –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã');
    }

    /**
     * –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã (index.html)
     */
    static setupMainNavigation() {
        // –ö–Ω–æ–ø–∫–∏ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        const startButtons = document.querySelectorAll('.start-button:not(.calendar-button)');
        const calendarButton = document.querySelector('.start-button.calendar-button');
        
        startButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                if (this.isTransitioning) return;
                
                const targetUrl = button.getAttribute('href');
                this.performTransition(targetUrl, 'main-page');
            });
        });

        // –û—Ç–¥–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        if (calendarButton) {
            calendarButton.addEventListener('click', (e) => {
                e.preventDefault();
                if (this.isTransitioning) return;
                
                const targetUrl = calendarButton.getAttribute('href');
                this.performTransition(targetUrl, 'calendar-page');
            });
        }
    }

    /**
     * –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (content.html)
     */
    static setupContentNavigation() {
        // –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –Ω–∞ –≥–ª–∞–≤–Ω—É—é (–µ—Å–ª–∏ –µ—Å—Ç—å)
        const backButton = document.querySelector('.back-btn[href="index.html"]');
        if (backButton) {
            backButton.addEventListener('click', (e) => {
                e.preventDefault();
                if (this.isTransitioning) return;
                
                this.performTransition('index.html', 'back-to-main');
            });
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        const calendarWidget = document.getElementById('calendarWidget');
        if (calendarWidget) {
            calendarWidget.addEventListener('click', (e) => {
                e.preventDefault();
                if (this.isTransitioning) return;
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–µ—Ä–≤–µ—Ä–Ω—É—é —Å–∏—Å—Ç–µ–º—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                if (window.authManager && window.authManager.isAuthenticated()) {
                    this.performTransition('calendar.html', 'to-calendar');
                } else {
                    this.performTransition('auth.html?returnTo=calendar', 'to-auth');
                }
            });
        }
    }

    /**
     * –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫–∞–ª–µ–Ω–¥–∞—Ä—è (calendar.html)
     */
    static setupCalendarNavigation() {
        // –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ –∫–æ–Ω—Ç–µ–Ω—Ç—É
        const backToContentButton = document.querySelector('.back-btn[href="content.html"]');
        if (backToContentButton) {
            backToContentButton.addEventListener('click', (e) => {
                e.preventDefault();
                if (this.isTransitioning) return;
                
                this.performTransition('content.html', 'back-to-content');
            });
        }

        // –í–∏–¥–∂–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        const contentWidget = document.getElementById('contentWidget');
        if (contentWidget) {
            contentWidget.addEventListener('click', (e) => {
                e.preventDefault();
                if (this.isTransitioning) return;
                
                this.performTransition('content.html', 'to-content');
            });
        }

        // –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ (–≤–æ–∑–≤—Ä–∞—Ç –Ω–∞ –≥–ª–∞–≤–Ω—É—é)
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', (e) => {
                if (this.isTransitioning) return;
                
                // –í—ã–ø–æ–ª–Ω—è–µ–º –≤—ã—Ö–æ–¥ –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é
                if (window.authManager) {
                    window.authManager.logout();
                }
                
                e.preventDefault();
                this.performTransition('index.html', 'logout');
            });
        }
    }

    /**
     * –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
     */
    static setupAuthNavigation() {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        const authForms = document.querySelectorAll('form[data-auth-form]');
        authForms.forEach(form => {
            form.addEventListener('submit', (e) => {
                // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                // –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ returnTo
            });
        });
    }

    /**
     * –í—ã–ø–æ–ª–Ω—è–µ—Ç –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
     */
    static performTransition(targetUrl, transitionType = 'default') {
        if (this.isTransitioning) {
            console.warn('‚ö†Ô∏è –ü–µ—Ä–µ—Ö–æ–¥ —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è');
            return;
        }

        if (!targetUrl) {
            console.error('‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç URL –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞');
            return;
        }

        console.log(`üîÑ –ù–∞—á–∏–Ω–∞–µ–º –ø–µ—Ä–µ—Ö–æ–¥: ${transitionType} -> ${targetUrl}`);
        this.isTransitioning = true;

        // –û—Ç–∫–ª—é—á–∞–µ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ
        document.body.classList.add('transitioning');

        try {
            // –§–∞–∑–∞ 1: –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            this.fadeOutPageElements(transitionType);

            // –§–∞–∑–∞ 2: –ü–æ—è–≤–ª–µ–Ω–∏–µ —á–µ—Ä–Ω–æ–≥–æ –æ–≤–µ—Ä–ª–µ—è
            setTimeout(() => {
                this.overlay.classList.add('active');
            }, 300);

            // –§–∞–∑–∞ 3: –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –Ω–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
            setTimeout(() => {
                this.navigateToPage(targetUrl);
            }, this.transitionDuration);

        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –≤–æ –≤—Ä–µ–º—è –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–µ—Ä–µ—Ö–æ–¥–∞:', error);
            this.fallbackTransition(targetUrl);
        }
    }

    /**
     * –ó–∞—Ç–µ–º–Ω—è–µ—Ç —ç–ª–µ–º–µ–Ω—Ç—ã —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
     */
    static fadeOutPageElements(transitionType) {
        console.log(`üåü –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤: ${transitionType}`);

        switch (transitionType) {
            case 'main-page':
                this.fadeOutMainPageElements();
                break;
            case 'calendar-page':
            case 'to-calendar':
                this.fadeOutGenericElements();
                break;
            case 'back-to-content':
            case 'to-content':
                this.fadeOutCalendarElements();
                break;
            case 'back-to-main':
            case 'logout':
                this.fadeOutGenericElements();
                break;
            default:
                this.fadeOutGenericElements();
        }
    }

    /**
     * –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
     */
    static fadeOutMainPageElements() {
        const elements = [
            '.game-title',
            '.game-subtitle', 
            '.start-button',
            '.main-footer'
        ];

        elements.forEach(selector => {
            const element = document.querySelector(selector);
            if (element) {
                element.classList.add('exit-text-animation');
            }
        });

        // –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —Ñ–æ–Ω–∞
        setTimeout(() => {
            const welcomeScreen = document.querySelector('.welcome-screen');
            if (welcomeScreen) {
                welcomeScreen.classList.add('exit-background-animation');
            }
        }, 200);
    }

    /**
     * –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
     */
    static fadeOutCalendarElements() {
        const elements = [
            '.calendar-header',
            '.calendar-controls',
            '.events-list-section',
            '.calendar-grid',
            '.content-widget'
        ];

        elements.forEach(selector => {
            const element = document.querySelector(selector);
            if (element) {
                element.classList.add('exit-text-animation');
            }
        });
    }

    /**
     * –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
     */
    static fadeOutGenericElements() {
        const elements = [
            '.sidebar',
            '.main-content',
            '.calendar-container',
            '.back-to-content',
            '.calendar-widget',
            '.content-widget'
        ];

        elements.forEach(selector => {
            const element = document.querySelector(selector);
            if (element) {
                element.classList.add('exit-text-animation');
            }
        });
    }

    /**
     * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ—è–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
     */
    static handlePageEntrance() {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–∏—à–ª–∏ –ª–∏ –º—ã —Å –¥—Ä—É–≥–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã —á–µ—Ä–µ–∑ –∞–Ω–∏–º–∞—Ü–∏—é
        const fromTransition = sessionStorage.getItem('pageTransition');
        
        if (fromTransition) {
            console.log('üì• –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ö–æ–¥–∞:', fromTransition);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á–µ—Ä–Ω—ã–π —ç–∫—Ä–∞–Ω
            this.overlay.classList.add('active');
            document.body.classList.add('transitioning');
            
            // –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
            setTimeout(() => {
                this.overlay.classList.remove('active');
                document.body.classList.remove('transitioning');
                document.body.classList.add('animation-complete');
                
                // –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                sessionStorage.removeItem('pageTransition');
            }, 500);
            
        } else {
            // –û–±—ã—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            setTimeout(() => {
                document.body.classList.add('animation-complete');
            }, 100);
        }
    }

    /**
     * –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç –Ω–∞ –Ω–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
     */
    static navigateToPage(targetUrl) {
        try {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–µ—Ä–µ—Ö–æ–¥–µ
            sessionStorage.setItem('pageTransition', 'true');
            
            console.log('üåê –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É:', targetUrl);
            window.location.href = targetUrl;
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ:', error);
            this.fallbackTransition(targetUrl);
        } finally {
            this.isTransitioning = false;
        }
    }

    /**
     * –†–µ–∑–µ—Ä–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –±–µ–∑ –∞–Ω–∏–º–∞—Ü–∏–∏
     */
    static fallbackTransition(targetUrl) {
        console.log('üîÑ –†–µ–∑–µ—Ä–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞:', targetUrl);
        setTimeout(() => {
            window.location.href = targetUrl;
            this.isTransitioning = false;
        }, 100);
    }

    /**
     * –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
     */
    static reset() {
        this.isTransitioning = false;
        document.body.classList.remove('transitioning');
        
        if (this.overlay) {
            this.overlay.classList.remove('active');
        }
        
        console.log('üîÑ –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ —Å–±—Ä–æ—à–µ–Ω–æ');
    }

    /**
     * –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Å–∏—Å—Ç–µ–º—ã
     */
    static getStatus() {
        return {
            isTransitioning: this.isTransitioning,
            hasOverlay: !!this.overlay,
            currentPage: window.location.pathname,
            elementsFound: {
                startButtons: document.querySelectorAll('.start-button').length,
                calendarWidget: !!document.getElementById('calendarWidget'),
                contentWidget: !!document.getElementById('contentWidget'),
                backButtons: document.querySelectorAll('.back-btn').length
            }
        };
    }

    /**
     * –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
     */
    static debug() {
        console.log('=== DEBUG UniversalPageTransitions ===');
        console.log('–°—Ç–∞—Ç—É—Å:', this.getStatus());
        console.log('Overlay —ç–ª–µ–º–µ–Ω—Ç:', this.overlay);
        console.log('–ü–µ—Ä–µ—Ö–æ–¥ –∞–∫—Ç–∏–≤–µ–Ω:', this.isTransitioning);
    }
}

/**
 * –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
 */
function initializeUniversalTransitions() {
    try {
        if (document.readyState === 'loading') {
            console.log('‚è≥ DOM –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, –∂–¥–µ–º DOMContentLoaded');
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(() => UniversalPageTransitions.init(), 50);
            });
        } else {
            console.log('‚úÖ DOM –≥–æ—Ç–æ–≤, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–µ—Ö–æ–¥—ã');
            setTimeout(() => UniversalPageTransitions.init(), 50);
        }
    } catch (error) {
        console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
    }
}

// –ó–∞–ø—É—Å–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
initializeUniversalTransitions();

// –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
if (typeof window !== 'undefined') {
    window.UniversalPageTransitions = UniversalPageTransitions;
}

// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ª—É—á–∞–π –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
if (document.readyState === 'complete') {
    console.log('üìÑ –î–æ–∫—É–º–µ–Ω—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∂–µ–Ω, –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è');
    setTimeout(() => UniversalPageTransitions.init(), 10);
}
