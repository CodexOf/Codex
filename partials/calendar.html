<!-- Календарь событий -->
<div class="calendar-container">
    <div class="calendar-header">
        <h1><i class="fas fa-calendar-alt"></i> Календарь событий</h1>
        <p class="calendar-subtitle">Планируйте и управляйте игровыми сессиями</p>
    </div>

    <!-- Панель управления -->
    <div class="calendar-controls">
        <div class="calendar-nav">
            <button class="calendar-nav-btn" id="prevMonth">
                <i class="fas fa-chevron-left"></i>
            </button>
            <h2 class="calendar-current-month" id="currentMonth">Январь 2025</h2>
            <button class="calendar-nav-btn" id="nextMonth">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        <div class="calendar-actions">
            <button class="btn-primary" id="addEventBtn">
                <i class="fas fa-plus"></i> Добавить событие
            </button>
            <button class="btn-secondary" id="todayBtn">
                <i class="fas fa-home"></i> Сегодня
            </button>
        </div>
    </div>

    <!-- Список событий -->
    <div class="events-list-section">
        <h3><i class="fas fa-list"></i> Ближайшие события</h3>
        <div class="events-list" id="eventsList">
            <p class="no-events">Нет запланированных событий</p>
        </div>
    </div>

    <!-- Сетка календаря -->
    <div class="calendar-grid" id="calendarGrid">
        <div class="calendar-weekdays">
            <div class="calendar-weekday">Пн</div>
            <div class="calendar-weekday">Вт</div>
            <div class="calendar-weekday">Ср</div>
            <div class="calendar-weekday">Чт</div>
            <div class="calendar-weekday">Пт</div>
            <div class="calendar-weekday">Сб</div>
            <div class="calendar-weekday">Вс</div>
        </div>
        <div class="calendar-days" id="calendarDays">
            <!-- Дни будут сгенерированы JavaScript -->
        </div>
    </div>
</div>

<!-- Модальное окно для добавления/редактирования события -->
<div class="modal-overlay" id="eventModal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Новое событие</h2>
            <button class="modal-close" id="closeModal">&times;</button>
        </div>
        <form id="eventForm" class="event-form">
            <div class="form-group">
                <label for="eventTitle">Название события</label>
                <input type="text" id="eventTitle" name="title" required 
                       placeholder="Например: Игровая сессия">
            </div>
            
            <div class="form-group">
                <label for="eventDate">Дата</label>
                <input type="date" id="eventDate" name="date" required>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="eventTimeStart">Время начала</label>
                    <input type="time" id="eventTimeStart" name="timeStart" required>
                </div>
                <div class="form-group">
                    <label for="eventTimeEnd">Время окончания</label>
                    <input type="time" id="eventTimeEnd" name="timeEnd">
                </div>
            </div>
            
            <div class="form-group">
                <label for="eventDescription">Описание</label>
                <textarea id="eventDescription" name="description" rows="4" 
                          placeholder="Описание события, планы на сессию и т.д."></textarea>
            </div>
            
            <div class="form-group">
                <label for="eventParticipants">Участники</label>
                <div class="participants-input">
                    <input type="text" id="participantInput" 
                           placeholder="Введите имя участника">
                    <button type="button" class="btn-add-participant" id="addParticipant">
                        <i class="fas fa-user-plus"></i>
                    </button>
                </div>
                <div class="participants-list" id="participantsList"></div>
            </div>
            
            <div class="form-group">
                <label for="eventColor">Цвет события</label>
                <div class="color-picker">
                    <button type="button" class="color-option active" data-color="#3498db" 
                            style="background-color: #3498db;"></button>
                    <button type="button" class="color-option" data-color="#e74c3c" 
                            style="background-color: #e74c3c;"></button>
                    <button type="button" class="color-option" data-color="#2ecc71" 
                            style="background-color: #2ecc71;"></button>
                    <button type="button" class="color-option" data-color="#f39c12" 
                            style="background-color: #f39c12;"></button>
                    <button type="button" class="color-option" data-color="#9b59b6" 
                            style="background-color: #9b59b6;"></button>
                    <button type="button" class="color-option" data-color="#1abc9c" 
                            style="background-color: #1abc9c;"></button>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn-secondary" id="cancelBtn">Отмена</button>
                <button type="submit" class="btn-primary">
                    <i class="fas fa-save"></i> Сохранить
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Стили календаря -->
<style>
/* Основные стили для сетки календаря */
.calendar-grid {
    background: #2a2a2a;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 30px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.calendar-weekdays {
    display: grid !important;
    grid-template-columns: repeat(7, 1fr) !important;
    gap: 10px;
    margin-bottom: 10px;
}

.calendar-weekday {
    text-align: center;
    font-weight: bold;
    color: #888;
    padding: 10px;
    font-size: 0.9rem;
}

.calendar-days {
    display: grid !important;
    grid-template-columns: repeat(7, 1fr) !important;
    gap: 10px;
}

.calendar-day {
    background: #1a1a1a;
    border-radius: 8px;
    min-height: 100px;
    padding: 10px;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
    overflow: hidden;
}

.calendar-day:hover {
    background: #252525;
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

.calendar-day-number {
    font-weight: bold;
    color: #ddd;
    margin-bottom: 5px;
    font-size: 1.1rem;
}

.calendar-day.other-month .calendar-day-number {
    color: #666;
}

.calendar-day.today {
    background: #1e3a57;
    border: 2px solid #3498db;
}

.calendar-day.has-events {
    border-left: 4px solid #3498db;
}

.calendar-event {
    background: #3498db;
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.75rem;
    margin-top: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    position: relative;
}

/* Всплывающая подсказка */
.event-tooltip {
    display: none;
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.95);
    color: white;
    padding: 10px 15px;
    border-radius: 6px;
    white-space: nowrap;
    z-index: 100;
    font-size: 0.85rem;
    margin-bottom: 5px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    max-width: 250px;
    white-space: normal;
    line-height: 1.4;
}

.event-tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-top: 6px solid rgba(0, 0, 0, 0.95);
}

.calendar-event:hover .event-tooltip {
    display: block;
}

/* Панель управления */
.calendar-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    flex-wrap: wrap;
    gap: 20px;
}

.calendar-nav {
    display: flex;
    align-items: center;
    gap: 20px;
}

.calendar-nav-btn {
    background: #2a2a2a;
    border: none;
    color: #fff;
    padding: 10px 15px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1.2rem;
    transition: all 0.3s;
}

.calendar-nav-btn:hover {
    background: #3a3a3a;
    transform: scale(1.1);
}

.calendar-current-month {
    color: #fff;
    font-size: 1.5rem;
    min-width: 200px;
    text-align: center;
}
/* Список событий */
.events-list-section {
    background: #2a2a2a;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.events-list-section h3 {
    color: #fff;
    margin-bottom: 15px;
    font-size: 1.2rem;
}

.events-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    max-height: 300px;
    overflow-y: auto;
    overflow-x: hidden;
}

/* Стили для скроллбара */
.events-list::-webkit-scrollbar {
    width: 8px;
}

.events-list::-webkit-scrollbar-track {
    background: #1a1a1a;
    border-radius: 4px;
}

.events-list::-webkit-scrollbar-thumb {
    background: #444;
    border-radius: 4px;
}

.events-list::-webkit-scrollbar-thumb:hover {
    background: #555;
}

.event-item {
    background: #1a1a1a;
    border-radius: 6px;
    padding: 12px 15px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    transition: all 0.3s;
    gap: 15px;
}

.event-item:hover {
    background: #252525;
    transform: translateX(3px);
}

/* Модальное окно */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(5px);
}

.modal-content {
    background: #2a2a2a;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid #444;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    color: #fff;
    margin: 0;
}

.modal-close {
    background: none;
    border: none;
    color: #888;
    font-size: 2rem;
    cursor: pointer;
    transition: color 0.3s;
}

.modal-close:hover {
    color: #fff;
}

/* Форма события */
.event-form {
    padding: 20px;
}

.form-group {
    margin-bottom: 20px;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.form-group label {
    display: block;
    color: #b0b0b0;
    margin-bottom: 8px;
    font-size: 0.9rem;
}

.form-group input,
.form-group textarea {
    width: 100%;
    background: #1a1a1a;
    border: 1px solid #444;
    border-radius: 6px;
    padding: 10px 15px;
    color: #fff;
    font-size: 1rem;
    transition: all 0.3s;
}

.form-group input:focus,
.form-group textarea:focus {
    outline: none;
    border-color: #3498db;
    background: #252525;
}

/* Участники */
.participants-input {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
}

.btn-add-participant {
    background: #3498db;
    border: none;
    color: white;
    padding: 10px 15px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-add-participant:hover {
    background: #2980b9;
}

.participants-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.participant-tag {
    background: #444;
    color: #fff;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.participant-remove {
    cursor: pointer;
    color: #888;
    transition: color 0.3s;
}

.participant-remove:hover {
    color: #e74c3c;
}

/* Выбор цвета */
.color-picker {
    display: flex;
    gap: 10px;
}

.color-option {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 3px solid transparent;
    cursor: pointer;
    transition: all 0.3s;
}

.color-option:hover {
    transform: scale(1.1);
}

.color-option.active {
    border-color: #fff;
    box-shadow: 0 0 0 2px #444;
}

.form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #444;
}

/* Кнопки */
.btn-primary, .btn-secondary {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-primary {
    background: #3498db;
    color: white;
}

.btn-primary:hover {
    background: #2980b9;
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3);
}

.btn-secondary {
    background: #555;
    color: white;
}

.btn-secondary:hover {
    background: #666;
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

/* Дополнительные стили для списка событий */
.event-info {
    flex: 1;
}

.event-title {
    color: #fff;
    font-weight: bold;
    margin-bottom: 5px;
}

.event-datetime {
    color: #888;
    font-size: 0.9rem;
}

.event-description {
    color: #ccc;
    font-size: 0.9rem;
    margin-top: 5px;
    line-height: 1.4;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

.event-participants {
    color: #b0b0b0;
    font-size: 0.85rem;
    margin-top: 5px;
}

.event-actions {
    display: flex;
    gap: 10px;
}

.event-actions button {
    background: none;
    border: none;
    color: #888;
    cursor: pointer;
    font-size: 1.1rem;
    padding: 5px 10px;
    transition: all 0.3s;
    border-radius: 4px;
}

.event-actions button:hover {
    color: #fff;
    background: rgba(255,255,255,0.1);
}

.no-events {
    text-align: center;
    color: #666;
    padding: 20px;
}
</style>

<!-- JavaScript для календаря -->
<script>
// Ждем небольшую задержку для полной загрузки DOM
setTimeout(function() {
    // Календарь событий для Codex
    (function() {
        'use strict';
        
        console.log('Инициализация календаря...');
        
        // Данные календаря
        let currentDate = new Date();
        let events = [];
        
        // Проверяем localStorage
        try {
            const savedEvents = localStorage.getItem('calendarEvents');
            if (savedEvents) {
                events = JSON.parse(savedEvents);
                console.log('Загружено событий из localStorage:', events.length);
            } else {
                console.log('localStorage пустой');
            }
        } catch (e) {
            console.error('Ошибка при чтении localStorage:', e);
            events = [];
        }
        
        let editingEventId = null;
        let selectedColor = '#3498db';
        let participants = [];

        // Элементы DOM
        const elements = {
            currentMonth: document.getElementById('currentMonth'),
            calendarDays: document.getElementById('calendarDays'),
            eventsList: document.getElementById('eventsList'),
            eventModal: document.getElementById('eventModal'),
            modalTitle: document.getElementById('modalTitle'),
            eventForm: document.getElementById('eventForm'),
            participantsList: document.getElementById('participantsList'),
            participantInput: document.getElementById('participantInput')
        };
        
        // Проверяем, что все элементы найдены
        console.log('Проверка элементов:', {
            currentMonth: !!elements.currentMonth,
            calendarDays: !!elements.calendarDays,
            eventsList: !!elements.eventsList,
            eventModal: !!elements.eventModal,
            modalTitle: !!elements.modalTitle,
            eventForm: !!elements.eventForm
        });
        
        // Выводим сами элементы для отладки
        console.log('Элемент eventModal:', elements.eventModal);

        // Инициализация
        function init() {
            console.log('Запуск init()...');
            renderCalendar();
            renderEventsList();
            attachEventListeners();
            console.log('Инициализация завершена');
        }

    // Отрисовка календаря
    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        
        // Обновляем заголовок
        const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 
                          'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
        elements.currentMonth.textContent = `${monthNames[month]} ${year}`;
        
        // Очищаем сетку
        elements.calendarDays.innerHTML = '';
        
        // Первый день месяца
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const prevLastDay = new Date(year, month, 0);
        
        // День недели первого дня (0 = воскресенье)
        let firstDayOfWeek = firstDay.getDay();
        // Преобразуем в понедельник = 0
        firstDayOfWeek = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;
        
        // Добавляем дни предыдущего месяца
        for (let i = firstDayOfWeek - 1; i >= 0; i--) {
            const day = prevLastDay.getDate() - i;
            createDayElement(new Date(year, month - 1, day), true);
        }
        
        // Добавляем дни текущего месяца
        for (let day = 1; day <= lastDay.getDate(); day++) {
            createDayElement(new Date(year, month, day), false);
        }
        
        // Добавляем дни следующего месяца
        const remainingDays = 42 - (firstDayOfWeek + lastDay.getDate());
        for (let day = 1; day <= remainingDays; day++) {
            createDayElement(new Date(year, month + 1, day), true);
        }
    }

    // Создание элемента дня
    function createDayElement(date, isOtherMonth) {
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day';
        
        if (isOtherMonth) {
            dayEl.classList.add('other-month');
        }
        
        // Проверяем, является ли день сегодняшним
        const today = new Date();
        if (date.toDateString() === today.toDateString()) {
            dayEl.classList.add('today');
        }
        
        // Номер дня
        const dayNumber = document.createElement('div');
        dayNumber.className = 'calendar-day-number';
        dayNumber.textContent = date.getDate();
        dayEl.appendChild(dayNumber);
        
        // События дня
        const dayEvents = events.filter(event => {
            const eventDate = new Date(event.date);
            return eventDate.toDateString() === date.toDateString();
        });
        
        if (dayEvents.length > 0) {
            dayEl.classList.add('has-events');
            
            // Показываем до 3 событий
            dayEvents.slice(0, 3).forEach(event => {
                const eventEl = document.createElement('div');
                eventEl.className = 'calendar-event';
                eventEl.style.backgroundColor = event.color || '#3498db';
                
                // Текст события
                const eventText = document.createElement('span');
                eventText.textContent = event.title;
                eventEl.appendChild(eventText);
                
                // Создаем всплывающую подсказку
                const tooltip = document.createElement('div');
                tooltip.className = 'event-tooltip';
                
                let tooltipContent = `<strong>${event.title}</strong>`;
                if (event.timeStart) {
                    tooltipContent += `<br>Время: ${event.timeStart}`;
                    if (event.timeEnd) {
                        tooltipContent += ` - ${event.timeEnd}`;
                    }
                }
                if (event.description) {
                    tooltipContent += `<br>${event.description}`;
                }
                if (event.participants && event.participants.length > 0) {
                    tooltipContent += `<br>Участники: ${event.participants.join(', ')}`;
                }
                
                tooltip.innerHTML = tooltipContent;
                eventEl.appendChild(tooltip);
                
                dayEl.appendChild(eventEl);
            });
            
            if (dayEvents.length > 3) {
                const moreEl = document.createElement('div');
                moreEl.className = 'calendar-event';
                moreEl.style.backgroundColor = '#666';
                moreEl.textContent = `+${dayEvents.length - 3} ещё`;
                dayEl.appendChild(moreEl);
            }
        }
        
        // Клик по дню
        dayEl.addEventListener('click', () => {
            if (!isOtherMonth) {
                // Создаем новую дату, чтобы избежать проблем с часовыми поясами
                const clickedDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                openEventModal(clickedDate);
            }
        });
        
        elements.calendarDays.appendChild(dayEl);
    }

    // Отрисовка списка событий
    function renderEventsList() {
        const sortedEvents = [...events].sort((a, b) => new Date(a.date) - new Date(b.date));
        const upcomingEvents = sortedEvents.filter(event => new Date(event.date) >= new Date());
        
        if (upcomingEvents.length === 0) {
            elements.eventsList.innerHTML = '<p class="no-events">Нет запланированных событий</p>';
            return;
        }
        
        elements.eventsList.innerHTML = '';
        
        upcomingEvents.forEach(event => {
            const eventEl = document.createElement('div');
            eventEl.className = 'event-item';
            
            const eventDate = new Date(event.date);
            const dateStr = eventDate.toLocaleDateString('ru-RU', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
            
            let timeStr = '';
            if (event.timeStart) {
                timeStr = event.timeStart;
                if (event.timeEnd) {
                    timeStr += ` - ${event.timeEnd}`;
                }
            }
            
            eventEl.innerHTML = `
                <div class="event-info">
                    <div class="event-title" style="color: ${event.color || '#3498db'}">${event.title}</div>
                    <div class="event-datetime">${dateStr}${timeStr ? ', ' + timeStr : ''}</div>
                    ${event.description ? 
                        `<div class="event-description">${event.description}</div>` : ''}
                    ${event.participants && event.participants.length > 0 ? 
                        `<div class="event-participants">
                            <i class="fas fa-users"></i> ${event.participants.join(', ')}
                        </div>` : ''}
                </div>
                <div class="event-actions">
                    <button onclick="CalendarModule.editEvent('${event.id}')" title="Редактировать">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="CalendarModule.deleteEvent('${event.id}')" title="Удалить">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            elements.eventsList.appendChild(eventEl);
        });
    }

    // Открытие модального окна
    function openEventModal(date = null) {
        console.log('Открытие модального окна...');
        console.log('Модальное окно:', elements.eventModal);
        
        if (!elements.eventModal) {
            console.error('Модальное окно не найдено!');
            return;
        }
        
        editingEventId = null;
        participants = [];
        selectedColor = '#3498db';
        
        elements.modalTitle.textContent = 'Новое событие';
        elements.eventForm.reset();
        
        if (date) {
            // Исправляем проблему с часовыми поясами
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;
            document.getElementById('eventDate').value = dateStr;
            console.log('Установлена дата:', dateStr);
        }
        
        renderParticipants();
        updateColorPicker();
        
        console.log('Показываем модальное окно...');
        elements.eventModal.style.display = 'flex';
        console.log('Модальное окно должно быть видимо');
    }

    // Закрытие модального окна
    function closeEventModal() {
        elements.eventModal.style.display = 'none';
        elements.eventForm.reset();
        participants = [];
        editingEventId = null;
    }

    // Добавление участника
    function addParticipant() {
        const name = elements.participantInput.value.trim();
        if (name && !participants.includes(name)) {
            participants.push(name);
            elements.participantInput.value = '';
            renderParticipants();
        }
    }

    // Удаление участника
    function removeParticipant(index) {
        participants.splice(index, 1);
        renderParticipants();
    }

    // Отрисовка списка участников
    function renderParticipants() {
        elements.participantsList.innerHTML = '';
        participants.forEach((participant, index) => {
            const tag = document.createElement('div');
            tag.className = 'participant-tag';
            tag.innerHTML = `
                ${participant}
                <span class="participant-remove" onclick="CalendarModule.removeParticipant(${index})">
                    <i class="fas fa-times"></i>
                </span>
            `;
            elements.participantsList.appendChild(tag);
        });
    }

    // Обновление выбора цвета
    function updateColorPicker() {
        document.querySelectorAll('.color-option').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.color === selectedColor);
        });
    }

    // Сохранение события
    function saveEvent(formData) {
        const eventData = {
            id: editingEventId || Date.now().toString(),
            title: formData.get('title'),
            date: formData.get('date'),
            timeStart: formData.get('timeStart'),
            timeEnd: formData.get('timeEnd'),
            description: formData.get('description'),
            participants: [...participants],
            color: selectedColor
        };
        
        if (editingEventId) {
            // Обновляем существующее событие
            const index = events.findIndex(e => e.id === editingEventId);
            if (index !== -1) {
                events[index] = eventData;
            }
        } else {
            // Добавляем новое событие
            events.push(eventData);
        }
        
        // Сохраняем в localStorage
        try {
            localStorage.setItem('calendarEvents', JSON.stringify(events));
            console.log('События сохранены в localStorage:', events.length);
        } catch (e) {
            console.error('Ошибка при сохранении в localStorage:', e);
        }
        
        // Обновляем интерфейс
        renderCalendar();
        renderEventsList();
        closeEventModal();
    }

    // Редактирование события
    function editEvent(eventId) {
        const event = events.find(e => e.id === eventId);
        if (!event) return;
        
        editingEventId = eventId;
        participants = [...(event.participants || [])];
        selectedColor = event.color || '#3498db';
        
        elements.modalTitle.textContent = 'Редактировать событие';
        
        // Заполняем форму
        document.getElementById('eventTitle').value = event.title;
        document.getElementById('eventDate').value = event.date;
        document.getElementById('eventTimeStart').value = event.timeStart || '';
        document.getElementById('eventTimeEnd').value = event.timeEnd || '';
        document.getElementById('eventDescription').value = event.description || '';
        
        renderParticipants();
        updateColorPicker();
        elements.eventModal.style.display = 'flex';
    }

    // Удаление события
    function deleteEvent(eventId) {
        if (confirm('Вы уверены, что хотите удалить это событие?')) {
            events = events.filter(e => e.id !== eventId);
            try {
                localStorage.setItem('calendarEvents', JSON.stringify(events));
                console.log('События обновлены в localStorage:', events.length);
            } catch (e) {
                console.error('Ошибка при сохранении в localStorage:', e);
            }
            renderCalendar();
            renderEventsList();
        }
    }

    // Привязка обработчиков событий
    function attachEventListeners() {
        console.log('Привязка обработчиков событий...');
        
        // Проверяем наличие кнопок
        const prevBtn = document.getElementById('prevMonth');
        const nextBtn = document.getElementById('nextMonth');
        const todayBtn = document.getElementById('todayBtn');
        const addEventBtn = document.getElementById('addEventBtn');
        
        console.log('Кнопки найдены:', {
            prevBtn: !!prevBtn,
            nextBtn: !!nextBtn,
            todayBtn: !!todayBtn,
            addEventBtn: !!addEventBtn
        });
        
        // Навигация по месяцам
        if (prevBtn) {
            prevBtn.addEventListener('click', () => {
                console.log('Клик на предыдущий месяц');
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar();
            });
        }
        
        if (nextBtn) {
            nextBtn.addEventListener('click', () => {
                console.log('Клик на следующий месяц');
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar();
            });
        }
        
        // Кнопка "Сегодня"
        if (todayBtn) {
            todayBtn.addEventListener('click', () => {
                console.log('Клик на Сегодня');
                currentDate = new Date();
                renderCalendar();
            });
        }
        
        // Кнопка добавления события
        if (addEventBtn) {
            addEventBtn.addEventListener('click', () => {
                console.log('Клик на Добавить событие');
                openEventModal();
            });
        }
        
        // Закрытие модального окна
        document.getElementById('closeModal').addEventListener('click', closeEventModal);
        document.getElementById('cancelBtn').addEventListener('click', closeEventModal);
        
        // Клик вне модального окна
        elements.eventModal.addEventListener('click', (e) => {
            if (e.target === elements.eventModal) {
                closeEventModal();
            }
        });
        
        // Форма события
        elements.eventForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(elements.eventForm);
            saveEvent(formData);
        });
        
        // Добавление участника
        document.getElementById('addParticipant').addEventListener('click', addParticipant);
        
        // Enter в поле участника
        elements.participantInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addParticipant();
            }
        });
        
        // Выбор цвета
        document.querySelectorAll('.color-option').forEach(btn => {
            btn.addEventListener('click', () => {
                selectedColor = btn.dataset.color;
                updateColorPicker();
            });
        });
        
        // Клавиатурные сокращения
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && elements.eventModal.style.display === 'flex') {
                closeEventModal();
            }
        });
    }

    // Экспорт функций для глобального доступа
    window.CalendarModule = {
        editEvent: editEvent,
        deleteEvent: deleteEvent,
        removeParticipant: removeParticipant
    };

    // Инициализация
    init();
    
    })();
}, 100); // Задержка 100мс для загрузки DOM
</script>
